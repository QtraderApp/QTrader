# QTrader Phase 1 — Implementation Plan

**Version:** 4.0 | **Date:** October 6, 2025 | **Status:** Stage 7 Complete - Production Ready | **Reference:** `docs/specs/phase01.md` v1.0

______________________________________________________________________

## 📊 Status Dashboard

### Completed Stages ✅

| Stage | Component              | Tests | Status      |
| ----- | ---------------------- | ----- | ----------- |
| 1     | Data Models & Adapters | 36    | ✅ COMPLETE |
| 2     | Orders & Ledger        | 55    | ✅ COMPLETE |
| 3     | Execution (Market/MOC) | 128   | ✅ COMPLETE |
| 4     | Execution (Limit/Stop) | 147   | ✅ COMPLETE |
| 5A    | Volume Participation   | 10    | ✅ COMPLETE |
| 5B    | Risk Management        | 54    | ✅ COMPLETE |
| 6A    | Indicators Framework   | 54    | ✅ COMPLETE |
| 6B    | Shorting & Dividends   | 53    | ✅ COMPLETE |
| 6C    | Instrument Abstraction | 23    | ✅ COMPLETE |
| 7     | Backtest Runner & CLI  | 110   | ✅ COMPLETE |

**Total Tests:** 470 passing, 10 skipped | **Code Coverage:** 96% | **Status:** Production Ready | **Next:** Stage 8 (Golden Baselines)

### Architecture Highlights

- ✅ Vendor-agnostic Bar model (pure OHLCV)
- ✅ Adjustment events tracked separately (AdjustmentEvent)
- ✅ Signal-based risk management (portfolio-scoped)
- ✅ Decimal precision throughout (no float errors)
- ✅ Conservative fill model (no look-ahead bias)
- ✅ Comprehensive indicators (SMA, EMA, BB, RSI, ATR, MACD)
- ✅ Symmetric dividend processing (long receives, short pays)
- ✅ Instrument abstraction (logical vs physical separation)
- ✅ Multi-source data support (Algoseek, CSV, extensible)
- ✅ Production-ready CLI (self-contained strategies)
- ✅ Complete event loop (warmup → signals → risk → execution → fills)

______________________________________________________________________

## 🎯 Quick Navigation

- **What's Next** → See end of document
- **Recent Stages** → Stage 6C (Instrument Abstraction) and Stage 7 (Backtest Runner)
- **Project Structure** → [Appendix A](#appendix-a-project-structure)
- **Development Workflow** → [Appendix B](#appendix-b-development-workflow)

______________________________________________________________________

## 1. Stages 1-5B: Foundation (Complete)

### Quick Summary

**Stages 1-5B** built the core foundation (detailed docs available in previous versions):

- **Stage 1:** Data models (Bar, AdjustmentEvent) + adapters (Algoseek, CSV)
- **Stage 2:** Orders (Market, MOC, Limit, Stop) + Position + Ledger
- **Stage 3:** Execution engine + fill policies + commissions
- **Stage 4:** Limit/Stop order evaluation (conservative touch rules)
- **Stage 5A:** Volume participation + partial fills
- **Stage 5B:** Risk management (signals → sized orders) + 4 sizing methods

**Total:** 438 tests passing | **Coverage:** 95%+

For detailed documentation of these stages, see previous version or individual stage documentation files.

______________________________________________________________________

## 2. Stage 6A: Indicators Framework ✅

**Duration:** 14 hours | **Tests:** 54 passing | **Status:** COMPLETE

### Production CLI

**Design Philosophy:** Self-contained strategy files (code + config in one place)

**Commands:**

```bash
# Main command
qtrader backtest --strategy examples/sma_crossover_strategy.py [options]

# Validation command (deprecated, use Instrument pattern)
qtrader validate-data --data <path> --symbols <list>
```

**Key Features:**

- ✅ Minimal required arguments (only `--strategy`)
- ✅ Auto-generated output directories with timestamps
- ✅ Configuration overrides via `--set KEY=VALUE`
- ✅ Debug mode: `--debug` (CSV exports for bars, indicators)
- ✅ Verbose logging: `--verbose`
- ✅ DataSourceResolver integration
- ✅ Instrument-based data loading

**Strategy File Pattern:**

```python
# examples/sma_crossover_strategy.py
from qtrader.models.instrument import Instrument, InstrumentType, DataSource

# Strategy parameters
config = {"fast": 20, "slow": 50}

# Complete backtest config
backtest_config = {
    "instruments": [
        Instrument("AAPL", InstrumentType.EQUITY, DataSource.ALGOSEEK, "1d")
    ],
    "initial_cash": 100_000,
    "start_date": "2023-01-01",
    "end_date": "2023-12-31",
}

class SMACrossover(Strategy):
    def on_bar(self, bar, ctx):
        # Strategy logic here
        pass
```

**Files:** Complete rewrite of `src/qtrader/cli.py` (~785 lines)

**Detailed Documentation:** `docs/stage7_summary.md` (450+ lines), `docs/cli_usage.md`

______________________________________________________________________

## 6. What's Next: Stage 8 (Golden Baselines)

**Duration:** 5-7 days | **Priority:** HIGH | **Status:** Ready to start

### Objective

Establish deterministic golden baselines for regression testing and validation. Create reference strategies with known-good results that must pass in CI.

### Implementation Plan

**Phase 1: Reference Strategies (2 days)**

1. **Buy-and-Hold Strategy**

   - Symbols: AAPL, MSFT, AMZN
   - Period: 2023-01-01 to 2023-12-31
   - Initial allocation: Equal weight
   - Expected behavior: One-time purchases, hold to end
   - Validates: Basic execution, portfolio tracking, dividends

1. **SMA Crossover Strategy**

   - Symbol: MSFT
   - Parameters: 20/50 SMA
   - Period: 2023-01-01 to 2023-12-31
   - Expected behavior: 15-25 round trips
   - Validates: Indicators, signals, risk management, multiple fills

**Phase 2: Golden File Generation (1 day)**

Create scripts to generate golden files:

```python
# scripts/generate_goldens.py
def generate_golden(strategy_name, strategy_class, config):
    """Run backtest, save results to tests/goldens/"""
    result = Backtest.run(strategy_class, config)

    golden = {
        "metadata": {
            "strategy": strategy_name,
            "generated": datetime.now().isoformat(),
            "version": "1.0"
        },
        "config": config,
        "results": {
            "final_cash": float(result.final_cash),
            "final_equity": float(result.final_equity),
            "total_return": float(result.total_return_pct),
            "num_trades": result.num_trades,
            "num_fills": result.num_fills,
            "commissions_paid": float(result.total_commissions),
        },
        "final_positions": result.final_positions,
        "key_snapshots": result.snapshots[::len(result.snapshots)//10],  # 10 samples
    }

    with open(f"tests/goldens/{strategy_name}_golden.json", "w") as f:
        json.dump(golden, f, indent=2)
```

**Phase 3: Validation Tests (1 day)**

```python
# tests/integration/goldens/test_buy_and_hold.py
def test_buy_and_hold_matches_golden():
    """Verify buy-and-hold results match golden file."""
    golden = load_golden("buy_and_hold")
    result = Backtest.run(BuyAndHold, golden["config"])

    assert_close(result.final_cash, golden["results"]["final_cash"])
    assert_close(result.final_equity, golden["results"]["final_equity"])
    assert result.num_trades == golden["results"]["num_trades"]
    # etc.
```

**Phase 4: Debug Bar-by-Bar (1-2 days)**

Add interactive debugging capability:

```python
# For troubleshooting golden mismatches
backtest = Backtest(strategy, config)
backtest.init()

while backtest.has_next():
    bar = backtest.next_bar()  # Step one bar
    print(f"Date: {bar.ts}, Portfolio: {backtest.portfolio.equity}")
    # Inspect state after each bar
```

**Phase 5: CI Integration (1 day)**

```yaml
# .github/workflows/test.yml
- name: Validate Golden Baselines
  run: pytest tests/integration/goldens/ -v --strict-markers
```

### Success Criteria

- ✅ 2 reference strategies implemented
- ✅ Golden files generated and committed
- ✅ Validation tests pass (exact match on key metrics)
- ✅ CI enforces golden validation on all PRs
- ✅ Documentation for adding new goldens

### Benefits

- **Regression Detection:** Catch unintended behavior changes
- **Determinism Proof:** Same inputs = same outputs every time
- **Onboarding:** Clear examples of correct usage
- **Debugging:** Known-good baselines for troubleshooting
- **Confidence:** Production readiness validation

### Files to Create

```
tests/
  integration/
    goldens/
      __init__.py
      test_buy_and_hold.py          (new)
      test_sma_crossover.py         (new)
      buy_and_hold_golden.json      (new)
      sma_crossover_golden.json     (new)

scripts/
  generate_goldens.py               (new)

examples/
  buy_and_hold_strategy.py          (new)
  # sma_crossover_strategy.py exists
```

### Estimated Effort

- Reference strategies: 2 days
- Golden generation: 1 day
- Validation tests: 1 day
- Debug bar-by-bar: 1-2 days
- CI integration: 1 day
- **Total: 5-7 days**

______________________________________________________________________

## 7. Future Stages (Phase 2)

After Stage 8, these are candidates for Phase 2:

### Performance & Optimization

- Parallel backtest execution (multiple strategies)
- Efficient indicator caching strategies
- Memory-mapped data loading for large datasets

### Advanced Features

- Multi-currency support (FX conversion)
- Futures and options support
- Intraday backtesting (minute/tick data)
- Portfolio rebalancing utilities
- Transaction cost analysis (TCA)

### Analytics & Reporting

- Tearsheet generation (Sharpe, Sortino, drawdown)
- Attribution analysis (performance decomposition)
- Risk metrics (VaR, CVaR, beta)
- HTML/PDF report generation
- Interactive web dashboard

### Risk Management Enhancements

- VOLATILITY_TARGET sizing
- KELLY_CRITERION sizing
- EQUAL_RISK_CONTRIBUTION
- Sector concentration limits
- Daily loss limits
- Correlation-based diversification

### Live Trading (Future)

- Broker integration (IBKR, Alpaca)
- Order management system (OMS)
- Real-time data feeds
- Position reconciliation
- Trade blotter

______________________________________________________________________

## Appendix A: Project Structure

```
src/qtrader/
├── api/                          # Public API
│   ├── strategy.py              # Strategy base class
│   ├── context.py               # Context for strategies
│   └── backtest.py              # Backtest runner ✅ Complete
├── models/                       # Core models
│   ├── bar.py                   # Bar, AdjustmentEvent
│   ├── instrument.py            # Instrument ✅ New in 6C
│   ├── order.py                 # Order types
│   ├── position.py              # Position tracking
│   ├── portfolio.py             # Portfolio with dividends
│   └── ledger.py                # Cash ledger
├── execution/                    # Execution engine
│   ├── engine.py                # Main engine
│   ├── fill_policy.py           # Fill rules
│   ├── commission.py            # Commission calc
│   ├── dividend_calculator.py   # Dividend math
│   └── dividend_processor.py    # Dividend events
├── risk/                         # Risk management
│   ├── signal.py                # Signal model
│   ├── policy.py                # RiskPolicy
│   ├── manager.py               # RiskManager
│   └── sizing.py                # Sizing methods
├── indicators/                   # Indicators framework
│   ├── base.py                  # Base Indicator
│   ├── manager.py               # IndicatorManager
│   ├── helpers.py               # Helper functions
│   ├── momentum/                # RSI, MACD
│   ├── trend/                   # SMA, EMA
│   └── volatility/              # BB, ATR
├── adapters/                     # Data adapters
│   ├── base.py                  # DataAdapter protocol
│   ├── resolver.py              # DataSourceResolver ✅ New in 6C
│   ├── algoseek_parquet.py      # Algoseek adapter (refactored)
│   └── csv_adapter.py           # CSV adapter (refactored)
├── config/                       # Configuration
│   ├── data_config.py
│   └── logging_config.py
├── validation/                   # Data validation
│   └── bar_validator.py
└── cli.py                        # CLI ✅ Complete rewrite in 7

config/
└── data_sources.yaml             # System-wide config ✅ New in 6C

tests/
├── unit/                         # 300+ unit tests
├── integration/                  # 160+ integration tests
└── goldens/                      # Golden baselines (Stage 8)

examples/
├── sma_crossover_strategy.py     # Updated for 6C/7
└── buy_and_hold_strategy.py      # Stage 8 (todo)
```

______________________________________________________________________

## Appendix B: Development Workflow

### Testing

```bash
# Run all tests
make test

# Run specific suite
pytest tests/unit/execution/ -v
pytest tests/integration/ -v

# With coverage
pytest --cov=qtrader --cov-report=html

# Fast (no coverage)
make test-fast

# Single test
pytest tests/unit/models/test_portfolio.py::test_apply_long_dividend -v
```

### Code Quality

```bash
# Format code
make format

# Lint
make lint

# Type check
make type-check

# All checks (format + lint + type + test)
make qa
```

### Git Workflow

1. Create branch: `git checkout -b feature/name`
1. Implement with TDD
1. Run `make qa` (must pass)
1. Commit (pre-commit hooks auto-format)
1. Push and create PR
1. Merge to master after review

### Running Backtests

```bash
# Simple example
qtrader backtest --strategy examples/sma_crossover_strategy.py

# With overrides
qtrader backtest --strategy examples/sma_crossover_strategy.py \
  --set initial_cash=50000 \
  --set start_date=2024-01-01

# Debug mode
qtrader backtest --strategy examples/sma_crossover_strategy.py \
  --debug --verbose

# Custom output directory
qtrader backtest --strategy examples/sma_crossover_strategy.py \
  --out ./my_results/
```

______________________________________________________________________

## 3. Stage 6B: Shorting & Dividends ✅

**Duration:** 10 hours | **Tests:** 53 passing | **Status:** COMPLETE

**Key Deliverables:**

- **DividendCalculator:** Calculates dividend/share from adjustment factors
  - Formula: `div = close_after * (cumulative_price_factor - 1)`
- **DividendProcessor:** Processes dividend events on ex-dates
  - Event indexing by ex-date (O(1) lookup)
  - Filters cash dividends only
  - **Symmetric handling:** SHORT pays (debit), LONG receives (credit)
- **Portfolio Integration:** Added transaction types
  - `TransactionType.DIVIDEND` (short pays)
  - `TransactionType.DIVIDEND_RECEIVED` (long receives)
- **Backtest Integration:** Optional `adjustment_events` parameter

**Architecture:** Dividends processed in event loop after fills, before borrow costs

**Total Return Support:** Complete tracking of both dividend costs (shorts) and income (longs)

**Files:** 2 core files, 4 test files | **Lines:** ~460 core + 580 tests

______________________________________________________________________

## 4. Stage 6C: Instrument Abstraction ✅

**Duration:** 2 weeks | **Tests:** 23 passing | **Status:** COMPLETE (October 6, 2025)

**Objective:** Replace file path-based configuration with logical instrument specification

### What Changed

**Before (Path-based):**

```python
backtest_config = {
    "data_paths": ["/data/AAPL.parquet", "/data/MSFT.parquet"],
    "symbols": ["AAPL", "MSFT"]
}
```

**After (Instrument-based):**

```python
from qtrader.models.instrument import Instrument, InstrumentType, DataSource

backtest_config = {
    "instruments": [
        Instrument("AAPL", InstrumentType.EQUITY, DataSource.ALGOSEEK, "1d"),
        Instrument("MSFT", InstrumentType.EQUITY, DataSource.ALGOSEEK, "1d")
    ]
}
```

### Key Components

1. **Instrument Model** (`src/qtrader/models/instrument.py`)

   - `Instrument` NamedTuple: symbol, type, source, frequency, metadata
   - `InstrumentType` enum: EQUITY, CRYPTO, FUTURE, FOREX, SIGNAL
   - `DataSource` enum: ALGOSEEK, DATABASE, IQFEED, BINANCE, CSV_FILE, API

1. **DataSourceResolver** (`src/qtrader/adapters/resolver.py`)

   - Maps `DataSource` enum → adapter classes
   - Loads `data_sources.yaml` config (system-wide)
   - Environment variable substitution (`${VAR_NAME}`)
   - Config search: explicit → ./config → ~/.qtrader

1. **Adapter Refactoring** (BREAKING CHANGE)

   - **Before:** Stateless - `adapter.read_bars(path, config)`
   - **After:** Stateful - `adapter = Adapter(config, instrument); adapter.read_bars(config)`
   - Symbol resolution: Ticker → SecId (via security master)
   - Path construction from templates in config

1. **CLI Integration** (`src/qtrader/cli.py`)

   - Loads `data_sources.yaml` at startup
   - New function: `_load_data_from_instruments()`
   - Validates `instruments` in backtest config
   - Displays instrument details in verbose mode

### Benefits

- ✅ Separation of concerns: "what to trade" vs "where to get data"
- ✅ Multi-source support: Mix Algoseek + CSV + Database in single backtest
- ✅ Cleaner configuration: Instrument objects replace file paths
- ✅ Extensibility: Add new sources via config (no code changes)
- ✅ Environment flexibility: Dev/prod configs via env vars

**Files Modified:** 7 files | **Lines:** +1,473 insertions, -339 deletions | **Coverage:** 96%

**Commits:** 7 logically separated commits (feat, refactor, test, docs, chore)

**Detailed Documentation:** `docs/stage6c_completion_summary.md` (400+ lines)

______________________________________________________________________

## 5. Stage 7: Backtest Runner & CLI ✅

**Duration:** 5 days | **Tests:** 110 passing | **Status:** COMPLETE (October 6, 2025)

**Objective:** Production-ready backtest runner with complete event loop and CLI

### Complete Trading Loop

Implemented 5-phase event loop in `src/qtrader/api/backtest.py`:

1. **Initialization:** `strategy.on_init(ctx)` - Register custom indicators
1. **Warmup:** Build indicator state (don't call `on_bar()`)
1. **Start:** `strategy.on_start(ctx)` - After warmup completes
1. **Trading Loop (NEW - 150 lines):**
   - Update context state (date, symbol, price)
   - Add bar to history
   - Process dividends (if ex-date)
   - `strategy.on_bar()` → get signals
   - For each signal:
     - `ctx.evaluate_signal()` → RiskDecision
     - `ctx.signal_to_order()` → OrderBase
     - `execution_engine.submit_order()`
   - `execution_engine.on_bar()` → fills
   - `strategy.on_fill()` for each fill
   - Save indicator state for crossovers
   - Snapshot portfolio every 10 bars
1. **Finalization:** `strategy.on_end()`

**Key Achievement:** Full signal → risk → order → fill → portfolio flow with comprehensive metadata

### Production CLI

**Key Deliverables:**

- Base Indicator class (registration, caching)
- 6 Built-in indicators:
  - SMA (Simple Moving Average)
  - EMA (Exponential Moving Average)
  - BollingerBands (upper/lower/middle)
  - RSI (Relative Strength Index)
  - ATR (Average True Range)
  - MACD (Moving Average Convergence Divergence)
- 13 Helper functions (max, min, avg, std, crossover, etc.)
- IndicatorManager (caching per indicator+params)
- Context integration (`ctx.ind.sma(20)`)
- Warmup system:
  - Auto-detects max lookback period
  - Lifecycle: `on_init()` → warmup → `on_start()` → `on_bar()`
  - CLI support: `--warmup` and `--warmup-bars N`
  - Indicators always valid after warmup

**Key Achievement:**

- No None handling needed when warmup enabled
- Indicators work seamlessly in strategies
- Custom indicators easily registered

**Files:** 3 core files, 5 test files **Lines:** ~850 core + 620 tests

**Example Usage:**

```python
class SMACrossover(Strategy):
    def on_bar(self, bar: Bar, ctx: Context):
        fast = ctx.ind.sma(20)  # No None check needed with warmup
        slow = ctx.ind.sma(50)

        if ctx.crossover(fast, slow):
            ctx.submit_signal(Signal.long("SPY"))
```

______________________________________________________________________

### Stage 6B: Shorting & Accruals ✅

**Duration:** 8 hours | **Tests:** 46 passing | **Status:** COMPLETE

**Key Deliverables:**

- **DividendCalculator** - Calculate dividend per share from adjustment factors

  - Formula: `div = close_after * (cumulative_price_factor - 1)`
  - 20 unit tests

- **DividendProcessor** - Process dividend events during backtests

  - Event indexing by ex-date (O(1) lookup)
  - Filters cash dividends only
  - Processes SHORT positions exclusively
  - 17 unit tests

- **Backtest Integration** - Dividend processing in event loop

  - Optional `adjustment_events` parameter
  - Processes dividends once per timestamp
  - Duplicate prevention for same-timestamp bars
  - 5 integration tests

- **Integration Tests** - End-to-end dividend scenarios

  - Position timing vs ex-date validation
  - Multiple dividends over time (quarterly)
  - Non-cash events filtered (stock splits)
  - 4 comprehensive tests

**Architecture:**

```
Backtest Event Loop:
  1. Process bar (price updates)
  2. Generate signals (strategy)
  3. Create orders (risk manager)
  4. Execute orders (execution engine)
  5. Process dividends (ex-date) ← SHORT POSITIONS ONLY
  6. Apply borrow costs (end of day)
```

**Current Limitation:**

- Only SHORT positions pay dividends (cost/debit)
- LONG positions do NOT receive dividends (income/credit)
- **Result:** Total return calculations incomplete

**Files:** 2 core files, 4 test files **Lines:** ~460 core + 580 tests

**Commits:**

```
89581d2 feat(execution): Add dividend calculator with adjustment factors
8efeb55 feat(execution): Add dividend processor for ex-date handling
77f1131 feat(api): Integrate dividend processing into backtest
2c26768 test(integration): Add comprehensive end-to-end shorting tests
b5b1fca docs: Complete Stage 6B implementation plan with summary
```

______________________________________________________________________

## 4. Stage 6B Extension: Long Position Dividends

**Status:** ✅ COMPLETE (October 6, 2025) **Duration:** Completed in 1.5 hours **Objective:** Complete total return calculations by adding dividend income for LONG positions

### Implementation Summary

**Commit:** `0a748c5` - feat(execution): Add long position dividend receipts

**Changes Delivered:**

- ✅ Added `TransactionType.DIVIDEND_RECEIVED` for long dividend income
- ✅ Implemented `Portfolio.apply_long_dividend()` method
- ✅ Extended `DividendProcessor._process_single_event()` for symmetric handling
- ✅ Added 7 new tests (4 portfolio unit, 3 processor unit)
- ✅ Updated 3 existing tests for new behavior
- ✅ Fixed type annotations (removed unnecessary None checks)

**Test Results:**

- **Total Tests:** 455 passing (+7 new), 10 skipped
- **Coverage:** >95% for all modified files
- **Runtime:** 1.17 seconds (full suite)

**Architecture:**

```python
# DividendProcessor now symmetric
if position.qty < 0:
    # SHORT: Pay dividend (debit cash)
    portfolio.apply_short_dividend(...)  # TransactionType.DIVIDEND
elif position.qty > 0:
    # LONG: Receive dividend (credit cash)
    portfolio.apply_long_dividend(...)   # TransactionType.DIVIDEND_RECEIVED
```

**Files Modified:**

- `src/qtrader/models/portfolio.py` (+30 lines, 2 methods)
- `src/qtrader/execution/dividend_processor.py` (+20 lines, docstrings)
- `tests/unit/models/test_portfolio.py` (+130 lines, 4 tests)
- `tests/unit/execution/test_dividend_processor.py` (+160 lines, 3 tests)
- `tests/integration/test_backtest_dividends.py` (1 test updated)

### Why This Matters

**Total Return = Price Return + Dividend Return**

- S&P 500: ~50% of total returns from reinvested dividends (50+ year period)
- Current system now tracks both costs (shorts pay) AND income (longs receive)
- Enables fair comparison of dividend-paying vs growth stocks
- Complete symmetric dividend processing model

### Key Implementation Details

**Code Changes:**

```python
# Portfolio: Symmetric dividend handling
def apply_short_dividend(...):
    """Debit cash for short dividend (qty < 0)."""
    self.cash.debit(amount=..., transaction_type="DIVIDEND")

def apply_long_dividend(...):
    """Credit cash for long dividend (qty > 0)."""
    self.cash.credit(amount=..., transaction_type="DIVIDEND_RECEIVED")

# DividendProcessor: Process both directions
if position.qty < 0:
    portfolio.apply_short_dividend(...)
elif position.qty > 0:
    portfolio.apply_long_dividend(...)
```

**Type Safety Improvements:**

Fixed circular dependency by removing unnecessary `None` checks:

```python
# Before (type error):
position = self.positions.get_position(symbol)
if position and position.qty < 0:  # ❌ Position depends on itself

# After (type safe):
position = self.positions.get_position(symbol)
if position.qty < 0:  # ✅ get_position() never returns None
```

### Examples

**Example 1: Single Long Position**

```python
# Position: 200 shares MSFT @ $400
# Ex-date: 2024-08-14
# Dividend: $0.50/share

Result:
- Cash credited: 200 × $0.50 = $100.00
- Transaction type: DIVIDEND_RECEIVED
- Log: "Long dividend on MSFT: 200 shares @ $0.50/share"
```

**Example 2: Mixed Portfolio (Real Backtest)**

```python
# Long 100 AAPL @ $180 (dividend: $0.45/share)
# Short 50 MSFT @ $400 (dividend: $0.50/share)
# Same ex-date

Result:
- AAPL credit: +$45.00 (long receives)
- MSFT debit: -$25.00 (short pays)
- Net cash impact: +$20.00
- Both processed in single ex-date cycle
```

### Success Criteria (All Met ✅)

**Functional:**

- ✅ Long positions receive dividend credits on ex-date
- ✅ Short positions still pay dividends (no regression)
- ✅ Cash balance reflects both costs and income
- ✅ Closed/new positions receive no dividends

**Technical:**

- ✅ All 455 tests pass (448 existing + 7 new)
- ✅ No performance degradation (1.17s full suite)
- ✅ Code coverage >95% for all modified files
- ✅ Pre-commit hooks pass (ruff, isort, mdformat)

### After Completion

Stage 6B now provides:

- ✅ Complete dividend tracking (both costs and income)
- ✅ Accurate total return calculations
- ✅ Support for mixed long/short portfolios
- ✅ Type-safe position handling (no circular dependencies)
- ✅ Transaction-level audit trail (DIVIDEND vs DIVIDEND_RECEIVED)
- ✅ Maintain transaction-level transparency

______________________________________________________________________

## 5. Future Stages (7-8)

### Stage 6C: Instrument Abstraction & Data Source Resolver (In Progress)

**Duration:** 2-3 weeks | **Priority:** HIGH | **Status:** Planning Complete

**Objective:** Replace file path-based configuration with Instrument abstraction for better scalability and multi-source support.

**Key Components:**

1. **Instrument Model** (`src/qtrader/models/instrument.py`)

   - Instrument class (symbol, type, source, frequency, metadata)
   - InstrumentType enum (EQUITY, CRYPTO, FUTURE, FOREX, SIGNAL)
   - DataSource enum (ALGOSEEK, DATABASE, IQFEED, BINANCE, CSV_FILE, API)

1. **DataSourceResolver** (`src/qtrader/adapters/resolver.py`)

   - Load data_sources.yaml configuration
   - Map DataSource enum to adapter classes
   - Instantiate adapters with instrument context
   - Environment variable substitution (${VAR})

1. **Adapter Refactoring**

   - Update AlgoseekParquetAdapter to accept Instrument
   - Update CSVAdapter to accept Instrument
   - Remove hardcoded path logic from adapters
   - Symbol → SecId lookup via security master

1. **Configuration Changes**

   - Create data_sources.yaml (system-wide config)
   - Update strategy config pattern (use instruments list)
   - Remove data_paths and symbols from backtest_config
   - Add frequency per-instrument with global default

1. **CLI Updates**

   - Load data_sources.yaml at startup
   - Pass Instrument objects to backtest runner
   - Update \_load_data_files() helper
   - Update config extraction helpers

1. **Testing**

   - Update 1-2 integration tests to use Instrument pattern
   - Update example strategies
   - Test multi-source scenarios
   - Test environment variable substitution

**Implementation Plan:**

- ✅ Phase 0: Documentation updated (spec + implementation plan)
- ⏳ Phase 1: Create Instrument model and enums (2 days)
- ⏳ Phase 2: Create DataSourceResolver (2 days)
- ⏳ Phase 3: Refactor adapters (3 days)
- ⏳ Phase 4: Update backtest runner (2 days)
- ⏳ Phase 5: Update CLI and examples (2 days)
- ⏳ Phase 6: Testing and validation (3 days)

**No Backward Compatibility:** Project is pre-production; clean break from data_paths pattern.

**Files to Modify:**

- `src/qtrader/models/instrument.py` (NEW)
- `src/qtrader/adapters/resolver.py` (NEW)
- `src/qtrader/adapters/algoseek_parquet.py` (REFACTOR)
- `src/qtrader/adapters/csv_adapter.py` (REFACTOR)
- `src/qtrader/api/backtest.py` (UPDATE)
- `src/qtrader/cli.py` (UPDATE)
- `examples/sma_crossover_strategy.py` (UPDATE)
- `config/data_sources.yaml` (NEW)
- `tests/integration/test_backtest_full_execution.py` (UPDATE 1-2 tests)

### Stage 7: Public API & CLI (Planned)

**Duration:** 5 days | **Priority:** HIGH | **Status:** 90% Complete

**Note:** Stage 7 core implementation and CLI are complete. Remaining work includes optional debugging features after Stage 6C.

**Completed:**

- ✅ Strategy base class and protocol
- ✅ Context with order submission API
- ✅ Backtest runner (full run mode)
- ✅ CLI implementation (self-contained strategy pattern)
- ✅ Config extraction and override system

**Remaining (Optional):**

- ⏳ Interactive debugging with `Backtest.next_bar()`
- ⏳ Debug output files (indicators.csv, bars.csv)
- ⏳ YAML config file loading

______________________________________________________________________

### Stage 8: Golden Baselines & Validation (Planned)

**Duration:** 5 days | **Priority:** HIGH

**Key Components:**

- Buy-and-Hold strategy (AAPL, MSFT, AMZN)
- SMA Crossover strategy (MSFT)
- Golden file generator scripts
- Golden validation tests
- CI checks for determinism

**Process:**

1. Implement reference strategies
1. Debug bar-by-bar with `Backtest.next_bar()`
1. Verify with `--debug-output`
1. Review results together
1. Commit golden files
1. Automate validation in CI

______________________________________________________________________

## Appendix A: Project Structure

```
src/qtrader/
├── api/                       # Public API
│   ├── strategy.py           # Strategy protocol
│   ├── context.py            # Context for strategies
│   ├── backtest.py           # Backtest runner
│   └── indicators.py         # Indicator framework
├── models/                    # Core models
│   ├── bar.py               # Bar, AdjustmentEvent, enums
│   ├── order.py             # Order types
│   ├── position.py          # Position tracking
│   └── ledger.py            # Cash ledger
├── execution/                 # Execution engine
│   ├── engine.py            # Main engine
│   ├── fill_policy.py       # Fill rules
│   ├── dividend_calculator.py
│   └── dividend_processor.py
├── risk/                      # Risk management
│   ├── signal.py            # Signal model
│   ├── policy.py            # RiskPolicy
│   ├── manager.py           # RiskManager
│   └── sizing.py            # Sizing methods
├── adapters/                  # Data adapters (private)
│   ├── algoseek_parquet.py
│   └── csv_adapter.py
└── config/                    # Configuration
    ├── data_config.py
    └── engine_config.py

tests/
├── unit/                      # Unit tests by component
├── integration/               # Integration tests
└── goldens/                   # Golden baselines (future)
```

______________________________________________________________________

## Appendix B: Development Workflow

### Testing

```bash
# Run all tests
make test

# Run specific module
pytest tests/unit/execution/ -v

# With coverage
pytest --cov=qtrader --cov-report=html

# Fast (no coverage)
make test-fast
```

### Code Quality

```bash
# Format code
make format

# Lint
make lint

# Type check
make type-check

# All checks
make qa
```

### Git Workflow

1. Create branch: `git checkout -b feature/name`
1. Implement with TDD
1. Run `make qa`
1. Commit (pre-commit hooks auto-format)
1. PR review
1. Merge to master

______________________________________________________________________

## Appendix C: Dependencies

```toml
[project]
name = "qtrader"
version = "0.1.0"
requires-python = ">=3.13"

dependencies = [
    "duckdb>=1.4.0",        # Parquet reading
    "pandas>=2.3.2",        # Data manipulation
    "pyarrow>=21.0.0",      # Parquet support
    "click>=8.0.0",         # CLI
    "pydantic>=2.11.9",     # Config validation
    "pyyaml>=6.0",          # YAML loading
    "pytz>=2024.1",         # Timezones
    "structlog>=24.4.0",    # Logging
]

[project.scripts]
qtrader = "qtrader.cli:main"
```

______________________________________________________________________

**Document Version:** 3.1 (October 6, 2025) **Status:** Stage 6B Extension Complete - Ready for Stage 7
