# Project Configuration
# ---------------------
PROJECT_NAME := QTrader
PYTHON_VERSION := 3.13
VENV := .venv
BIN := $(VENV)/bin
SRC_DIR := src

# Terminal Colors
# ---------------
CYAN := \033[0;36m
GREEN := \033[0;32m
RED := \033[0;31m
BLUE := \033[0;34m
YELLOW := \033[1;33m
BOLD := \033[1m
END := \033[0m

# Default target
# --------------
.DEFAULT_GOAL := help

# Utility Functions
# -----------------
define log_info
echo "$(BLUE)‚ÑπÔ∏è  $(1)$(END)"
endef

define log_success
echo "$(GREEN)‚úÖ $(1)$(END)"
endef

define log_warning
echo "$(YELLOW)‚ö†Ô∏è  $(1)$(END)"
endef

define log_error
echo "$(RED)‚ùå $(1)$(END)"
endef


################################################################################
# HELP
################################################################################
.PHONY: help
help: ## üìö Show this help message
	@echo "$(BOLD)$(PROJECT_NAME) Development Makefile$(END)"
	@echo ""
	@echo "$(CYAN)üìã Available Commands:$(END)"
	@echo ""
	@echo "$(BOLD)üöÄ Setup & Environment:$(END)"
	@grep -E '^(check-uv|sync|upgrade|install-hooks|setup|clean):.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-20s$(END) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BOLD)üé® Code Quality:$(END)"
	@grep -E '^(format|format-md|lint|lint-check|type-check|quality):.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-20s$(END) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BOLD)üß™ Testing:$(END)"
	@grep -E '^(test[a-zA-Z_-]*|qa):.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-20s$(END) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BOLD)üìì Development Tools:$(END)"
	@grep -E '^(setup-kernel|run-jupyter):.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-20s$(END) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(BOLD)üîß Utilities:$(END)"
	@grep -E '^(help):.*?## .*$$' $(MAKEFILE_LIST) | awk 'BEGIN {FS = ":.*?## "}; {printf "  $(CYAN)%-20s$(END) %s\n", $$1, $$2}'
	@echo ""
	@echo "$(YELLOW)üí° Quick Start:$(END)"
	@echo "  $(CYAN)make setup$(END)     - Complete development environment setup"
	@echo "  $(CYAN)make qa$(END)        - Run full quality assurance (format + lint + test)"
	@echo "  $(CYAN)make test$(END)      - Run all tests with coverage"
	@echo ""


################################################################################
# PROJECT SETUP
################################################################################
.PHONY: check-uv
check-uv: ## üîß Verify UV package manager is available
	@echo "$(BLUE)‚ÑπÔ∏è  Checking UV package manager...$(END)"
	@command -v uv >/dev/null 2>&1 || { \
		echo "$(RED)‚ùå UV is not installed$(END)"; \
		echo "$(RED)Please install UV from: https://docs.astral.sh/uv/getting-started/installation/$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ UV package manager is available$(END)"

.PHONY: sync
sync: check-uv ## üì¶ Sync dependencies and create virtual environment
	@echo "$(BLUE)‚ÑπÔ∏è  Syncing dependencies with UV...$(END)"
	@uv sync --all-packages --all-groups || { \
		echo "$(RED)‚ùå Failed to sync packages$(END)"; \
		exit 1; \
	}
	@echo "$(BLUE)‚ÑπÔ∏è  Installing qtrader in editable mode...$(END)"
	@uv pip install -e . --quiet || { \
		echo "$(RED)‚ùå Failed to install package$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ Dependencies synced successfully$(END)"

.PHONY: upgrade
upgrade: check-uv ## üîÑ Upgrade all packages to latest versions
	@echo "$(BLUE)‚ÑπÔ∏è  Upgrading all packages with UV...$(END)"
	@uv lock --upgrade || { \
		echo "$(RED)‚ùå Failed to upgrade packages$(END)"; \
		exit 1; \
	}
	@echo "$(BLUE)‚ÑπÔ∏è  Syncing upgraded dependencies...$(END)"
	@uv sync --all-packages --all-groups || { \
		echo "$(RED)‚ùå Failed to sync upgraded packages$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ All packages upgraded and synced successfully$(END)"

.PHONY: install-hooks
install-hooks: sync ## ü™ù Install pre-commit hooks
	@echo "$(BLUE)‚ÑπÔ∏è  Installing pre-commit hooks...$(END)"
	@uv run pre-commit install || { \
		echo "$(RED)‚ùå Failed to install pre-commit hooks$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ Pre-commit hooks installed$(END)"

.PHONY: pre-commit
pre-commit: sync ## üîç Run pre-commit hooks manually
	@echo "$(BLUE)‚ÑπÔ∏è  Running pre-commit hooks...$(END)"
	@uv run pre-commit run --all-files || { \
		echo "$(RED)‚ùå Pre-commit hooks failed$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ Pre-commit hooks passed$(END)"

.PHONY: setup
setup: sync install-hooks ## üöÄ Complete development environment setup
	@echo "$(GREEN)‚úÖ Development environment setup complete!$(END)"
	@echo "$(BLUE)üí° Use 'uv run <command>' to run commands in the environment$(END)"
	@echo "$(BLUE)üí° Example: uv run python $(SRC_DIR)/main.py$(END)"

.PHONY: clean
clean: ## üßπ Clean workspace (remove virtual env, cache, and temp files)
	@echo "$(BLUE)‚ÑπÔ∏è  Cleaning development environment...$(END)"
	@rm -rf $(VENV)
	@find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true
	@find . -type f -name "*.pyc" -delete 2>/dev/null || true
	@find . -type f -name "*.pyo" -delete 2>/dev/null || true
	@rm -rf build/ dist/ *.egg-info .pytest_cache/ .ruff_cache/ .mypy_cache/
	@rm -f .coverage coverage.xml
	@rm -rf htmlcov/ mypy-report/ .coverage.*
	@echo "$(GREEN)‚úÖ Workspace cleaned$(END)"


################################################################################
# CODE QUALITY
################################################################################

.PHONY: format
format: sync ## üé® Format code with ruff, isort, and markdown (matches pre-commit)
	@echo "$(BLUE)‚ÑπÔ∏è  Formatting Python code with ruff (fix + format)...$(END)"
	@uv run ruff check --fix --target-version py313 $(SRC_DIR)/
	@uv run ruff format --target-version py313 $(SRC_DIR)/
	@echo "$(BLUE)‚ÑπÔ∏è  Formatting imports with isort...$(END)"
	@uv run isort $(SRC_DIR)/
	@echo "$(BLUE)‚ÑπÔ∏è  Formatting Markdown files...$(END)"
	@uv run mdformat . --wrap=no --end-of-line=lf || echo "$(YELLOW)‚ö†Ô∏è  mdformat not installed, run 'uv add --dev mdformat mdformat-gfm mdformat-tables'$(END)"
	@echo "$(GREEN)‚úÖ Code and markdown formatting completed$(END)"

.PHONY: lint
lint: sync ## üîç Lint code and fix auto-fixable issues (matches pre-commit)
	@echo "$(BLUE)‚ÑπÔ∏è  Linting code...$(END)"
	@uv run ruff check --fix --target-version py313 $(SRC_DIR)/
	@echo "$(GREEN)‚úÖ Code linting completed$(END)"

.PHONY: lint-check
lint-check: sync ## üìã Check code without making changes (matches pre-commit)
	@echo "$(BLUE)‚ÑπÔ∏è  Checking code quality...$(END)"
	@uv run ruff check --target-version py313 $(SRC_DIR)/
	@uv run ruff format --target-version py313 --check $(SRC_DIR)/
	@uv run isort --check-only $(SRC_DIR)/
	@echo "$(GREEN)‚úÖ Code quality check passed$(END)"

.PHONY: format-md
format-md: sync ## üìù Format Markdown files only
	@echo "$(BLUE)‚ÑπÔ∏è  Formatting Markdown files...$(END)"
	@uv run mdformat . --wrap=no --end-of-line=lf || echo "$(YELLOW)‚ö†Ô∏è  mdformat not installed, run 'uv add --dev mdformat mdformat-gfm mdformat-tables'$(END)"
	@echo "$(GREEN)‚úÖ Markdown formatting completed$(END)"

.PHONY: type-check
type-check: sync ## üî¨ Run type checking with MyPy
	@echo "$(BLUE)‚ÑπÔ∏è  Running type checks with MyPy...$(END)"
	@uv run mypy $(SRC_DIR)/ || { \
		echo "$(RED)‚ùå Type checking failed$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ Type checking completed$(END)"

.PHONY: quality
quality: format lint-check type-check ## üèÜ Run all code quality checks
	@echo "$(GREEN)‚úÖ All code quality checks passed$(END)"

.PHONY: qa
qa: quality test ## üîç Full quality assurance (code quality + tests)
	@echo "$(GREEN)‚úÖ Quality assurance complete - ready for production!$(END)"


################################################################################
# TESTING
################################################################################

.PHONY: test
test: sync ## üß™ Run all tests with coverage
	@echo "$(BLUE)‚ÑπÔ∏è  Running all tests with coverage...$(END)"
	@uv run pytest --cov --cov-report=term-missing --cov-report=html || { \
		echo "$(RED)‚ùå Tests failed$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ All tests passed$(END)"

.PHONY: test-fast
test-fast: sync ## ‚ö° Run tests without coverage (faster)
	@echo "$(BLUE)‚ÑπÔ∏è  Running tests (fast mode)...$(END)"
	@uv run pytest -v || { \
		echo "$(RED)‚ùå Tests failed$(END)"; \
		exit 1; \
	}
	@echo "$(GREEN)‚úÖ All tests passed$(END)"
